name: Static code checks

on:
  push:
    branches: master
  pull_request:
    branches: master
  workflow_dispatch:

jobs:
  changes:
    name: Check for file changes
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    outputs:
      ci: ${{ steps.filter.outputs.ci }}
      javascript: ${{ steps.filter.outputs.javascript }}
      markdown: ${{ steps.filter.outputs.markdown }}
      shell: ${{ steps.filter.outputs.shell }}
      static-lint: ${{ steps.filter.outputs.static-lint }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: data/config/dorny-paths-filter.yaml
          list-files: 'shell'

  dependencies-check:
    name: Renovate dependencies
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Renovate
        uses: renovatebot/github-action@v43.0.6
        with:
          configurationFile: 'data/config/renovate.json'
          token: ${{ secrets.RENOVATE_TOKEN }}

  javascript-lint:
    name: JavaScript linting
    needs: changes
    if: >-
      ${{
        needs.changes.outputs.javascript == 'true' ||
        needs.changes.outputs.static-lint == 'true'
      }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Run ESLint with SuperLinter
        uses: super-linter/super-linter@v5
        env:
          VALIDATE_JAVASCRIPT_ES: true

  shell-lint:
    name: Shell linting
    needs: changes
    if: >-
      ${{
        needs.changes.outputs.shell == 'true' ||
        needs.changes.outputs.static-lint == 'true'
      }}
    runs-on: ubuntu-latest
    steps:
      - name: Pull the latest code
        uses: actions/checkout@v4
      - name: Lint
        uses: luizm/action-sh-checker@v0.9.0
        env:
          SHELLCHECK_OPTS: >-
            --exclude SC2153,SC2154
            --enable add-default-case
            --enable avoid-nullary-conditions
            --enable check-unassigned-uppercase
            --enable deprecate-which
            --enable quote-safe-variables
            --enable require-variable-braces
          SHFMT_OPTS: >-
              --case-indent
              --func-next-line
              --indent 2
              --space-redirects

  yaml-lint:
    name: YAML linting
    needs: changes
    if: ${{ needs.changes.outputs.ci == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Pull the latest code
        uses: actions/checkout@v4
      - name: Lint
        run: |
          bash <(curl https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash)
          ./actionlint -color -verbose
